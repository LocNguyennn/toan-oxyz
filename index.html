<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Kiểm Tra Oxyz - Nguyễn Tấn Lộc</title>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body oncontextmenu="return false;">
    <!-- <script>
        // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        document.onkeydown = function (e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) return false;
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }
    </script> -->

    <div id="nameModal">
        <div class="name-box">
            <h2 style="color:var(--gold); margin-top:0;">CHÀO MỪNG CÁC EM</h2>
            <p>Vui lòng nhập Họ và Tên để bắt đầu bài kiểm tra:</p>
            <input type="text" id="studentName" class="name-input" placeholder="Ví dụ: Nguyễn Văn A">
            <br>
            <button id="start-btn" class="btn"
                style="text-align:center; width:100%; background:var(--accent); color:white; font-weight:bold;"
                onclick="startGame()">BẮT ĐẦU NGAY</button>
        </div>
    </div>

    <header>
        <h1 style="margin:5px 0; color:var(--gold);">GIẢI MÃ HÌNH HỌC OXYZ</h1>
        <p style="margin:5px 0; font-weight:bold;">Nguyễn Tấn Lộc</p>
    </header>

    <div class="game-container">
        <div class="quiz-card">
            <span id="round-title" class="round-indicator">VÒNG 1</span>
            <div id="q-area">
                <div id="q-text" class="question-text"></div>
                <div id="ans-zone" class="options-grid"></div>
            </div>
            <button id="next-btn" class="next-btn" onclick="handleNext()">TIẾP THEO ➜</button>
        </div>

        <div class="sidebar">
            <div class="image-box">
                <img src="hinh_game.jpg" style="width:100%; height:100%; object-fit:cover;"
                    onerror="this.src='https://via.placeholder.com/350x260?text=Oxyz+Challenge'">
                <div id="grid" class="grid-overlay"></div>
            </div>
            <div class="status">
                <div style="font-size: 1.6rem; color: var(--gold); font-weight: bold;">ĐIỂM: <span
                        id="score">0.00</span></div>
                <div id="student-display" style="color:var(--accent); font-weight:bold; margin: 10px 0;">Học sinh: ...
                </div>
                <div style="color: #8b949e; border-top: 1px solid #30363d; padding-top: 10px;">Tiến trình: <span
                        id="q-num">1</span> / 22</div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_POST_URL = "https://script.google.com/macros/s/AKfycbyxec0KqnET5cImoL4YCpGDJudaEHtJQAcUVcPB0L8dVgxGehn11wAEsaw8cO8sWIrZlg/exec";
        const GOOGLE_SCRIPT_GET_URL = "https://script.google.com/macros/s/AKfycbx7vmZXxZnUX2MrSv3_Aa5lUlO1lhB7crNRJd7ayMg05bGC6qvWpMneFeRai4ELi8Rg/exec";

        // CORE SYSTEM LOGIC (DO NOT MODIFY)
        // Auth removed


        let studentName = "";
        let currentIdx = 0, score = 0, userAns = "", v2Ans = [];
        let startTime;

        const questions = [];

        async function loadQuestions() {
            const startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.innerText = "ĐANG TẢI DỮ LIỆU...";
                startBtn.style.opacity = "0.5";
            }
            try {
                // Fetch from Proxy (Public Access)
                const res = await fetch(GOOGLE_SCRIPT_GET_URL);
                if (!res.ok) throw new Error("Không thể kết nối đến máy chủ!");

                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // The server now returns the EXACT exam structure (12 v1, 4 v2, 6 v3)
                // randomly selected and ordered. We just use it directly.
                questions.length = 0;
                data.forEach(q => questions.push(q));

                console.log(`Exam loaded from server: ${questions.length} questions`);

                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.innerText = "BẮT ĐẦU NGAY";
                    startBtn.style.opacity = "1";
                }

            } catch (error) {
                console.error(error);
                alert("Lỗi tải câu hỏi: " + error.message);
                if (startBtn) startBtn.innerText = "LỖI KẾT NỐI";
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Load questions when page loads
        window.addEventListener('DOMContentLoaded', loadQuestions);

        function startGame() {
            const input = document.getElementById('studentName').value;
            if (input.trim() === "") { alert("Vui lòng nhập họ tên trước khi thi!"); return; }
            studentName = input;
            document.getElementById('nameModal').style.display = 'none';
            document.getElementById('student-display').innerText = "Học sinh: " + studentName;
            startTime = new Date();
            resetGame();
        }

        function resetGame() {
            currentIdx = 0; score = 0;
            document.getElementById('score').innerText = "0.00";
            const grid = document.getElementById('grid'); grid.innerHTML = "";
            for (let i = 0; i < 24; i++) {
                let t = document.createElement('div'); t.className = 'tile'; t.id = 'tile-' + i; grid.appendChild(t);
            }
            render();
        }

        function processContent(text, isAnswer = false) {
            if (!text) return isAnswer ? "" : "Trống";
            let content = String(text);

            const driveRegex = /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)[^\s"']*/gi;
            content = content.replace(driveRegex, "https://lh3.googleusercontent.com/d/$1");

            const imgUrlRegex = /(https?:\/\/.*?\.(?:png|jpg|jpeg|gif|webp|svg|bmp)(?:\?.*?)?|https:\/\/lh3\.googleusercontent\.com\/d\/[a-zA-Z0-9_-]+)/gi;

            const imgStyle = isAnswer
                ? "max-width:100%; max-height:150px; border-radius:8px; margin:5px 0; display:block;"
                : "max-width:100%; border-radius:12px; margin:10px 0; box-shadow:0 8px 24px rgba(0,0,0,0.5); border: 1px solid #30363d;";

            content = content.replace(imgUrlRegex, (match) => {
                return `<div style="text-align:center; width:100%;"><img src="${match}" referrerpolicy="no-referrer" style="${imgStyle}" onerror="console.error('IMAGE LOAD FAILED:', this.src);"></div>`;
            });

            return content;
        }

        function render() {
            try {
                if (!questions || questions.length === 0) {
                    alert("Không có câu hỏi nào để hiển thị!");
                    return;
                }
                const q = questions[currentIdx];
                if (!q) {
                    alert(`Lỗi: Không tìm thấy câu hỏi số ${currentIdx + 1}`);
                    return;
                }

                const processedQuestion = processContent(q.q);

                let localIdx = 0;
                for (let i = 0; i <= currentIdx; i++) {
                    if (questions[i].type === q.type) {
                        localIdx++;
                    }
                }

                document.getElementById('q-num').innerText = currentIdx + 1;
                document.getElementById('q-text').innerHTML = `<span class="q-label" style="color:var(--gold); font-weight:bold;">Câu ${localIdx}:</span> ` + processedQuestion;
                const zone = document.getElementById('ans-zone'), nextBtn = document.getElementById('next-btn');
                zone.innerHTML = ''; nextBtn.style.display = 'none';

                if (q.type === 'v1') {
                    document.getElementById('round-title').innerText = "Vòng 1: Trắc nghiệm (0.25đ/câu)";
                    if (!q.a || !Array.isArray(q.a)) throw new Error("Dữ liệu đáp án (a) bị thiếu hoặc sai định dạng");

                    q.a.forEach((opt, i) => {
                        let b = document.createElement('button'); b.className = 'btn';
                        const processedOpt = processContent(opt, true);
                        b.innerHTML = `<b>${String.fromCharCode(65 + i)}.</b> ${processedOpt}`;

                        b.style.display = "block";
                        b.style.textAlign = "left";

                        b.onclick = () => {
                            if (i === q.c) {
                                b.classList.add('correct');
                                score += 0.25;
                                openTile();
                            } else {
                                b.classList.add('wrong');
                                // Scope selector to zone to avoid index mismatch with start-btn
                                zone.querySelectorAll('.btn')[q.c].classList.add('correct');
                            }
                            zone.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
                            nextBtn.style.display = 'block'; updateScore();
                        };
                        zone.appendChild(b);
                    });
                } else if (q.type === 'v2') {
                    document.getElementById('round-title').innerText = "Vòng 2: Đúng/Sai (Tối đa 1.0đ/câu)";
                    if (!q.items || !Array.isArray(q.items)) throw new Error("Dữ liệu ý đúng sai (items) bị thiếu");

                    v2Ans = new Array(4).fill(null);
                    q.items.forEach((item, i) => {
                        let div = document.createElement('div'); div.className = 'tf-row';
                        const processedLabel = processContent(item.l, true);
                        div.innerHTML = `<div style="flex:1; padding-right:10px;"><b>${String.fromCharCode(97 + i)}.</b> ${processedLabel}</div><div style="display:flex; gap:8px;">
                    <button class="btn-tf" id="t-${i}" onclick="setV2(${i},true)">Đúng</button>
                    <button class="btn-tf" id="f-${i}" onclick="setV2(${i},false)">Sai</button>
                </div>`;
                        zone.appendChild(div);
                    });
                    nextBtn.style.display = 'block'; nextBtn.innerText = "XÁC NHẬN CÂU NÀY";
                } else {
                    document.getElementById('round-title').innerText = "Vòng 3: Trả lời ngắn (0.5đ/câu)";
                    userAns = "";
                    zone.innerHTML = `<div class="short-answer-zone"><div class="answer-display" id="disp">- - -</div>
                <div class="numpad">${[1, 2, 3, 4, 5, 6, 7, 8, 9, 0, '.', '-'].map(n => `<button class="num-btn" onclick="press('${n}')">${n}</button>`).join('')}
                <button class="num-btn" style="grid-column:span 3; background:var(--wrong); border:none;" onclick="press('C')">XÓA TẤT CẢ</button></div></div>`;
                    nextBtn.style.display = 'block'; nextBtn.innerText = "GỬI ĐÁP ÁN";
                }
                MathJax.typesetPromise();
            } catch (err) {
                console.error("Render Error:", err);
                alert("Lỗi hiển thị: " + err.message);
            }
        }

        function setV2(i, v) {
            v2Ans[i] = v;
            document.getElementById(`t-${i}`).className = v ? 'btn-tf active-t' : 'btn-tf';
            document.getElementById(`f-${i}`).className = !v ? 'btn-tf active-f' : 'btn-tf';
        }

        function press(v) {
            if (v === 'C') userAns = ""; else if (userAns.length < 6) userAns += v;
            document.getElementById('disp').innerText = userAns || "- - -";
        }

        function openTile() {
            const tiles = document.querySelectorAll('.tile:not(.open)');
            if (tiles.length) tiles[Math.floor(Math.random() * tiles.length)].classList.add('open');
        }

        function updateScore() { document.getElementById('score').innerText = score.toFixed(2); }

        function handleNext() {
            if (currentIdx >= questions.length) return;
            const q = questions[currentIdx];

            if (q.type === 'v2') {
                let correctCount = 0;
                q.items.forEach((item, i) => { if (v2Ans[i] === item.r) correctCount++; });
                const pointsMap = [0, 0.1, 0.25, 0.5, 1.0];
                score += pointsMap[correctCount];
                if (correctCount === 4) openTile();
            } else if (q.type === 'v3') {
                if (userAns == q.c) { score += 0.5; openTile(); }
            }
            updateScore();
            currentIdx++;

            if (currentIdx < questions.length) {
                render();
            } else {
                finish();
            }
        }

        function finish() {
            try {
                document.getElementById('next-btn').style.display = 'none'; // Prevent double clicking
                let comment = "";
                const s = score;
                if (s <= 3.5) comment = "Bạn cần cố gắng nhiều.";
                else if (s <= 5) comment = "Bạn cần cố gắng.";
                else if (s <= 6.5) comment = "Bạn ở mức tầm trung.";
                else if (s < 8) comment = "Bạn khá.";
                else if (s <= 9) comment = "Bạn giỏi.";
                else if (s <= 9.8) comment = "Bạn xuất sắc.";
                else comment = "Đỉnh của chóp...";

                // Calculate duration
                const endTime = new Date();
                const durationMs = startTime ? (endTime - startTime) : 0;
                const minutes = Math.floor(durationMs / 60000);
                const seconds = Math.floor((durationMs % 60000) / 1000);
                const timeString = `${minutes} phút ${seconds} giây`;

                document.getElementById('round-title').innerText = "KẾT THÚC BÀI THI";
                document.getElementById('q-area').innerHTML = `<div style="text-align:center;">
                <div class="result-text" id="result-comment">${comment}</div>
                <h3>Tổng điểm tích lũy: ${score.toFixed(2)} / 10.0</h3>
                <p>Thời gian làm bài: <b>${timeString}</b></p>
                <p id="upload-status" class="loading-dots">Đang lưu kết quả lên hệ thống</p>
                <button class="btn" style="width:100%; text-align:center; margin-top:20px;" onclick="location.reload()">LÀM LẠI BÀI KHÁC</button>
            </div>`;
                document.querySelectorAll('.tile').forEach(t => t.classList.add('open'));

                sendToSheet(studentName, score.toFixed(2), timeString);
            } catch (e) {
                console.error("Error in finish():", e);
                alert("Lỗi khi kết thúc bài thi: " + e.message);
            }
        }

        function sendToSheet(name, finalScore, time) {
            // Use URLSearchParams for reliable x-www-form-urlencoded transmission
            const formData = new URLSearchParams();
            formData.append('name', name);
            formData.append('score', finalScore);
            formData.append('time', time);

            fetch(GOOGLE_SCRIPT_POST_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData.toString()
            }).then(() => {
                const statusEl = document.getElementById('upload-status');
                if (statusEl) {
                    statusEl.innerText = "✅ Đã lưu điểm thành công vào hệ thống!";
                    statusEl.classList.remove('loading-dots');
                }
            }).catch(err => {
                console.error("Fetch error:", err);

                const statusEl = document.getElementById('upload-status');
                if (statusEl) statusEl.innerText = "❌ Lỗi kết nối, hãy chụp màn hình điểm lại nhé.";
            });
        }
    </script>
</body>

</html>