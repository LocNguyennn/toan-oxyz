<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ki·ªÉm Tra T√≠ch Ph√¢n - ThS. Tr·∫ßn Tr·ªçng Tr·ªã</title>
    <script>
      window.MathJax = { tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] }, options: { processHtmlClass: 'mathjax-process' } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --correct: #238636; --wrong: #da3633; --gold: #f1c40f; --ai: #8a2be2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; }
        
        header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid var(--accent); width: 100%; padding-bottom: 10px; }
        
        #nameModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .name-box { background: var(--card); padding: 30px; border-radius: 15px; text-align: center; border: 2px solid var(--accent); max-width: 400px; }
        .name-input { padding: 12px; width: 85%; font-size: 1.1rem; border-radius: 6px; border: 1px solid var(--accent); margin-bottom: 20px; background: #0d1117; color: white; outline: none; }

        /* Thanh ƒëi·ªÅu h∆∞·ªõng c√¢u h·ªèi */
        .nav-container { width: 100%; max-width: 1050px; display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; justify-content: center; }
        .nav-btn { width: 35px; height: 35px; border-radius: 5px; border: 1px solid #30363d; background: #21262d; color: white; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
        .nav-btn.active { background: var(--accent); border-color: white; font-weight: bold; }
        .nav-btn.done { border-bottom: 3px solid var(--correct); }
        .nav-btn.missing { background: #3d1a1a; border: 1px solid var(--wrong); }

        .game-container { max-width: 1050px; width: 100%; display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 850px) { .game-container { grid-template-columns: 1fr; } }
        
        .quiz-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #30363d; min-height: 480px; display: flex; flex-direction: column; }
        .part-header { color: var(--gold); font-weight: bold; background: #21262d; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid var(--gold); font-size: 0.9rem; }
        .question-text { font-size: 1.05rem; margin-bottom: 15px; line-height: 1.7; text-align: justify; }

        .options-grid { display: grid; gap: 8px; flex-grow: 1; }
        .btn { background: #21262d; border: 1px solid #30363d; color: var(--text); padding: 12px 15px; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.2s; font-size: 0.95rem; display: flex; align-items: flex-start; gap: 10px; }
        .btn.selected { background: #30363d; border-color: var(--accent); border-width: 2px; }

        /* Khung b√™n ph·∫£i ch·ª©a b√†n ph√≠m ho·∫∑c ·∫£nh */
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .numpad-box { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; }
        .answer-display { background: #000; color: var(--accent); font-size: 1.8rem; padding: 8px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 15px; font-family: monospace; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .num-btn { background: #30363d; border: 1px solid #58a6ff44; color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
        .num-btn:active { background: var(--accent); }

        .img-container { text-align: center; margin: 10px 0; background: white; padding: 5px; border-radius: 8px; }
        .img-container img { max-height: 160px; }

        .submit-btn { margin-top: 20px; width: 100%; padding: 15px; background: var(--gold); color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        
        #final-area { display: none; width: 100%; max-width: 900px; padding: 20px; }
        .sol-card { background: var(--card); padding: 25px; border-radius: 12px; margin-top: 20px; border: 1px solid #30363d; }
        .ai-btn { background: linear-gradient(45deg, #4b0082, #8a2be2); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .ai-sol-box { display: none; background: #0d1117; padding: 20px; border-radius: 10px; border-left: 4px solid var(--ai); margin-top: 15px; line-height: 1.8; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="nameModal">
    <div class="name-box">
        <h2 style="color:var(--gold)">H·ªÜ TH·ªêNG KI·ªÇM TRA</h2>
        <p>ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n THPT Gia ƒê·ªãnh</p>
        <input type="text" id="studentName" class="name-input" placeholder="Nh·∫≠p H·ªç v√† T√™n c·ªßa em...">
        <button class="btn" style="width:100%; background:var(--accent); color:white; justify-content: center;" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
    </div>
</div>

<header>
    <h1 style="color:var(--gold); font-size: 1.5rem; margin: 5px 0;">CHINH PH·ª§C T√çCH PH√ÇN 12</h1>
    <p style="margin: 0; font-size: 0.9rem;">ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
</header>

<div class="nav-container" id="nav-bar"></div>

<div class="game-container" id="game-main">
    <div class="quiz-card">
        <div id="part-info" class="part-header"></div>
        <span id="q-title" class="question-title" style="color:var(--accent); font-weight:bold; margin-bottom:10px; display:block;"></span>
        <div id="q-area" class="mathjax-process">
            <div id="q-text" class="question-text"></div>
            <div id="ans-zone" class="options-grid"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top: 20px;">
            <button class="btn" style="flex:1; justify-content:center;" onclick="moveQ(-1)">PREV</button>
            <button class="btn" style="flex:1; justify-content:center; background:var(--correct);" onclick="moveQ(1)">NEXT</button>
        </div>
    </div>

    <div class="sidebar">
        <div id="numpad-container" class="numpad-box" style="display:none;">
            <div style="font-weight:bold; margin-bottom:5px; color:var(--gold)">ƒê√ÅP √ÅN C·ª¶A EM</div>
            <div class="answer-display" id="disp">- - -</div>
            <div class="numpad">
                ${[1,2,3,4,5,6,7,8,9,0,'.','-'].map(n=>`<button class='num-btn' onclick='press("${n}")'>${n}</button>`).join('')}
                <button class="num-btn" style="grid-column:span 3; background:var(--wrong)" onclick="press('C')">X√ìA</button>
            </div>
        </div>

        <div class="image-box">
            <img src="hinh_game.jpg" style="width:100%; height:100%; object-fit:cover" onerror="this.src='https://via.placeholder.com/350x260?text=Euler'">
            <div id="grid" class="grid-overlay"></div>
        </div>
        <div class="status">
            <div style="font-size: 1.2rem; color: var(--gold);">ƒêI·ªÇM T·∫†M T√çNH: <span id="score">0.00</span></div>
            <div id="student-display" style="color:var(--accent); margin: 5px 0; font-size:0.9rem;">H·ªçc sinh: ...</div>
            <button class="submit-btn" onclick="checkFinalSubmit()">N·ªòP B√ÄI T·∫¨P</button>
        </div>
    </div>
</div>

<div id="final-area">
    <div style='text-align:center; padding:30px; background:var(--card); border-radius:15px; border:2px solid var(--gold);'>
        <h2 style='color:var(--gold); margin-top:0;'>K·∫æT QU·∫¢ CU·ªêI C√ôNG</h2>
        <h3 style='color:var(--accent); font-size: 2rem;' id="final-score-display"></h3>
    </div>
    <div id="sol-content"></div>
    <button class="btn" style="margin: 40px 0; width:100%; text-align:center; justify-content:center;" onclick="location.reload()">L√ÄM L·∫†I B√ÄI THI</button>
</div>

<script>
    const questions = [
        // PH·∫¶N I
        { part: 1, type: 'v1', num: 1, q: "M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y l√† <b>sai</b>?", a: ["$\\displaystyle \\int f'(x) dx = f(x)+C$ v·ªõi m·ªçi h√†m $f(x)$ c√≥ ƒë·∫°o h√†m tr√™n $\\mathbb{R}$","$\\displaystyle \\int [f(x)+g(x)] dx = \\int f(x)dx + \\int g(x)dx$ v·ªõi m·ªçi h√†m $f(x), g(x)$ c√≥ ƒë·∫°o h√†m tr√™n $\\mathbb{R}$","$\\displaystyle \\int k f(x) dx = k \\int f(x)dx$ v·ªõi m·ªçi h·∫±ng s·ªë $k$ v√† v·ªõi m·ªçi h√†m s·ªë $f(x)$ c√≥ ƒë·∫°o h√†m tr√™n $\\mathbb{R}$","$\\displaystyle \\int [f(x)-g(x)] dx = \\int f(x)dx - \\int g(x)dx$ v·ªõi m·ªçi h√†m $f(x), g(x)$ c√≥ ƒë·∫°o h√†m tr√™n $\\mathbb{R}$"], c: 2, sol: "<b>AI Ph√¢n t√≠ch:</b> Kh·∫≥ng ƒë·ªãnh C <b>Sai</b> v√¨ thi·∫øu ƒëi·ªÅu ki·ªán $k \\neq 0$. N·∫øu $k=0$, v·∫ø tr√°i l√† h·∫±ng s·ªë, v·∫ø ph·∫£i l√† 0." },
        { part: 1, type: 'v1', num: 2, q: "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x$ l√†:", a: ["$-\\sin x + C$", "$\\sin x + C$", "$\\cos x + C$", "$-\\cos x + C$"], c: 1, sol: "<b>AI Ph√¢n t√≠ch:</b> Ta c√≥ $(\\sin x)' = \\cos x$ n√™n $\\displaystyle \\int \\cos x dx = \\sin x + C$." },
        { part: 1, type: 'v1', num: 11, q: "Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng v·ªÅ di·ªán t√≠ch $S$? <div class='img-container'><img src='cau11.png'></div>", a: ["$S = \\displaystyle \\int_a^b [f_2(x)-f_1(x)] dx$", "$\\displaystyle S = \\int_a^b [f_1(x)-f_2(x)] dx$", "$S = \\displaystyle \\pi \\int_a^b [f_1(x)-f_2(x)]^2 dx$", "$S = \\displaystyle \\pi \\int_a^b [f_1(x)-f_2(x)] dx$"], c: 1, sol: "<b>AI Ph√¢n t√≠ch:</b> $f_1(x)$ n·∫±m tr√™n $f_2(x)$ n√™n di·ªán t√≠ch b·∫±ng t√≠ch ph√¢n c·ªßa (h√†m tr√™n - h√†m d∆∞·ªõi)." },
        
        // PH·∫¶N II (TF)
        { 
            part: 2, type: 'v2', num: 1, q: "Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x) = \\dfrac{x^2+1}{x}$ tr√™n $(0 ;+\\infty)$.", 
            items: [ {l: "$F(x) = f'(x), \\forall x \\in (0; +\\infty)$", r: false}, {l: "$F(x)+2025$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$", r: true}, {l: "$F(x) = x^2 + \\ln x + 2025$", r: false}, {l: "$F(1) = 3/2 \\Rightarrow F(x) = \\dfrac{x^2}{2} + 2$", r: false} ], 
            sol: "<b>AI Ph√¢n t√≠ch:</b><br>‚Ä¢ a) Sai v√¨ $F'=f$.<br>‚Ä¢ b) ƒê√∫ng v√¨ h·∫±ng s·ªë kh√¥ng l√†m ƒë·ªïi ƒë·∫°o h√†m.<br>‚Ä¢ c) Sai: $\\displaystyle F(x) = \\dfrac{x^2}{2} + \\ln x + C$.<br>‚Ä¢ d) Sai: h·∫±ng s·ªë $C$ gi·∫£i ra b·∫±ng $1$." 
        },
        { 
            part: 2, type: 'v2', num: 4, q: "Cho $y=f(x)$ li√™n t·ª•c tr√™n $(0;+\\infty)$, c√≥ BBT c·ªßa $f'(x)$ nh∆∞ sau: <div class='img-container'><img src='cau4_ds.png'></div>", 
            items: [ {l: "$\\int_2^5 f'(x)dx = f(5)-f(2)$", r: true}, {l: "$\\int_2^3 f'(x)dx = 1$", r: false}, {l: "Di·ªán t√≠ch gi·ªõi h·∫°n b·ªüi $f'(x), Ox$ b·∫±ng $1/2$", r: false}, {l: "N·∫øu $\\int_2^5 |f'(x)|dx = 5$ th√¨ $f(5)=5$", r: false} ], 
            sol: "<b>AI Ph√¢n t√≠ch:</b> √ù b sai v√¨ $f'(x) < 0$ tr√™n $(2,3)$ n√™n t√≠ch ph√¢n √¢m. √ù d sai v√¨ d·ªØ ki·ªán ch·ªâ suy ra $f(2)+f(5)=3$." 
        },

        // PH·∫¶N III (Short answer)
        { part: 3, type: 'v3', num: 1, q: "Bi·∫øt $\\displaystyle \\int (\\sin x - \\cos x)^2 dx = x + \\dfrac{1}{a} \\cos bx + C$. T√≠nh $S = a+b$.", c: "4", sol: "<b>AI Ph√¢n t√≠ch:</b> Khai tri·ªÉn $(\\sin x - \\cos x)^2 = 1 - \\sin 2x$. Nguy√™n h√†m ra $x + \\dfrac{1}{2}\\cos 2x$. V·∫≠y $a=2, b=2$." },
        { part: 3, type: 'v3', num: 4, q: "Cho h√†m s·ªë $\\displaystyle f(x) = \\begin{cases} 3x^2-x-9 & x \\ge 2 \\\\ x-1 & x < 2 \\end{cases}$. T√≠nh $\\displaystyle I = \\int_0^3 f(x)dx$.", c: "7.5", sol: "<b>AI Ph√¢n t√≠ch:</b> T√°ch t√≠ch ph√¢n t·∫°i $x=2$: $\\displaystyle \\int_0^2 (x-1)dx + \\int_2^3 (3x^2-x-9)dx = 0 + 7.5 = 7.5$." },
        { part: 3, type: 'v3', num: 5, q: `Cho h√†m s·ªë $y=f(x)$ c√≥ ƒë·ªì th·ªã ƒë·∫°o h√†m $y=f'(x)$ nh∆∞ h√¨nh. Bi·∫øt $S_A=4, S_B=10$ v√† $f(0)=2$. T√≠nh $f(3)$. <div class='img-container'><img src='cau5_kq.png'></div>`, c: "-4", sol: "<b>AI Ph√¢n t√≠ch:</b><div class='img-container'><img src='cau5_kq_lg.png'></div><br>$\\displaystyle f(3) = f(0) + \\int_0^1 f'(x)dx + \\int_1^3 f'(x)dx = 2 + 4 - 10 = -4$." },
        { part: 3, type: 'v3', num: 6, q: `M·ªôt khu√¥n vi√™n d·∫°ng n·ª≠a h√¨nh tr√≤n gi·ªõi h·∫°n b·ªüi parabol $y=x^2$ v√† ƒë∆∞·ªùng tr√≤n $y=\\sqrt{20-x^2}$. T√≠nh s·ªë ti·ªÅn (ngh√¨n ƒë·ªìng) tr·ªìng hoa C·∫©m T√∫ C·∫ßu (g·∫°ch ch√©o) bi·∫øt m·ªói $m^2$ gi√° 250 ngh√¨n ƒë·ªìng. (L√†m tr√≤n h√†ng ƒë∆°n v·ªã). <div class='img-container'><img src='cau6_kq.png'></div>`, c: "4985", sol: "<b>AI Ph√¢n t√≠ch:</b><div class='img-container'><img src='cau6_kq_lg.png'></div><br>Giao ƒëi·ªÉm $x = \\pm 2$. Di·ªán t√≠ch $\\displaystyle S \\approx 19.9396 m^2$. S·ªë ti·ªÅn = $19.9396 \\times 250 \\approx 4985$." }
    ];

    let userAnswers = new Array(questions.length).fill(null);
    let v2CurrentAnswers = [null, null, null, null];

    function startGame() {
        const input = document.getElementById('studentName').value;
        if(!input.trim()) return alert("Nh·∫≠p h·ªç t√™n nh√© em!");
        studentName = input;
        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('student-display').innerText = "H·ªçc sinh: " + studentName;
        
        // T·∫°o thanh ƒëi·ªÅu h∆∞·ªõng
        const nav = document.getElementById('nav-bar');
        questions.forEach((q, i) => {
            let b = document.createElement('button');
            b.className = 'nav-btn'; b.id = 'nav-' + i; b.innerText = i + 1;
            b.onclick = () => jumpToQ(i);
            nav.appendChild(b);
        });
        
        const grid = document.getElementById('grid'); grid.innerHTML = "";
        for(let i=0; i<24; i++) {
            let t = document.createElement('div'); t.className='tile'; t.id='tile-'+i; grid.appendChild(t);
        }
        render();
    }

    function jumpToQ(idx) {
        // L∆∞u c√¢u hi·ªán t·∫°i tr∆∞·ªõc khi nh·∫£y (cho V√≤ng 2 v√† 3)
        saveCurrentAnswer();
        currentIdx = idx;
        render();
    }

    function saveCurrentAnswer() {
        const q = questions[currentIdx];
        if(q.type === 'v2') {
            if(!v2CurrentAnswers.includes(null)) userAnswers[currentIdx] = [...v2CurrentAnswers];
        }
        updateNavStatus();
    }

    function moveQ(step) {
        saveCurrentAnswer();
        let next = currentIdx + step;
        if(next >= 0 && next < questions.length) {
            currentIdx = next;
            render();
        }
    }

    function render() {
        const q = questions[currentIdx];
        document.getElementById('part-info').innerHTML = q.part === 1 ? "PH·∫¶N I. TR·∫ÆC NGHI·ªÜM 4 PH∆Ø∆†NG √ÅN" : (q.part === 2 ? "PH·∫¶N II. TR·∫ÆC NGHI·ªÜM ƒê√öNG SAI" : "PH·∫¶N III. TR·∫ÆC NGHI·ªÜM TR·∫¢ L·ªúI NG·∫ÆN");
        document.getElementById('q-title').innerText = "C√¢u " + q.num + ".";
        document.getElementById('total-q').innerText = currentIdx + 1;
        document.getElementById('q-text').innerHTML = q.q;
        
        const zone = document.getElementById('ans-zone'); zone.innerHTML = '';
        const numpad = document.getElementById('numpad-container'); numpad.style.display = 'none';

        if(q.type === 'v1') {
            q.a.forEach((opt, i) => {
                let b = document.createElement('button'); b.className = 'btn';
                if(userAnswers[currentIdx] === i) b.classList.add('selected');
                b.innerHTML = `<b>${['A','B','C','D'][i]}.</b> ${opt}`;
                b.onclick = () => {
                    userAnswers[currentIdx] = i;
                    document.querySelectorAll('.btn').forEach(el => el.classList.remove('selected'));
                    b.classList.add('selected');
                    updateNavStatus();
                };
                zone.appendChild(b);
            });
        } else if(q.type === 'v2') {
            v2CurrentAnswers = userAnswers[currentIdx] ? [...userAnswers[currentIdx]] : [null, null, null, null];
            q.items.forEach((item, i) => {
                let d = document.createElement('div'); d.className = 'tf-row';
                d.innerHTML = `<div class='tf-label'><b>${['a','b','c','d'][i]})</b> ${item.l}</div>
                    <div style='display:flex;gap:5px'>
                        <button class='btn-tf ${v2CurrentAnswers[i] === true ? 'active-t' : ''}' id='t-${i}' onclick='setV2(${i},true)'>ƒê√∫ng</button>
                        <button class='btn-tf ${v2CurrentAnswers[i] === false ? 'active-f' : ''}' id='f-${i}' onclick='setV2(${i},false)'>Sai</button>
                    </div>`;
                zone.appendChild(d);
            });
        } else {
            numpad.style.display = 'block';
            userAns = userAnswers[currentIdx] || "";
            document.getElementById('disp').innerText = userAns || "- - -";
        }

        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + currentIdx).classList.add('active');
        MathJax.typesetPromise();
    }

    function setV2(i, val) {
        v2CurrentAnswers[i] = val;
        document.getElementById(`t-${i}`).className = val === true ? 'btn-tf active-t' : 'btn-tf';
        document.getElementById(`f-${i}`).className = val === false ? 'btn-tf active-f' : 'btn-tf';
        saveCurrentAnswer();
    }

    function press(val) {
        if(val === 'C') userAns = ""; else if(userAns.length < 8) userAns += val;
        document.getElementById('disp').innerText = userAns || "- - -";
        userAnswers[currentIdx] = userAns;
        updateNavStatus();
    }

    function updateNavStatus() {
        questions.forEach((q, i) => {
            let b = document.getElementById('nav-' + i);
            b.classList.remove('done', 'missing');
            if(userAnswers[i] !== null && userAnswers[i] !== "") b.classList.add('done');
        });
    }

    function checkFinalSubmit() {
        saveCurrentAnswer();
        let missing = [];
        questions.forEach((q, i) => {
            if(userAnswers[i] === null || userAnswers[i] === "") missing.push(i + 1);
        });

        if(missing.length > 0) {
            missing.forEach(idx => document.getElementById('nav-' + (idx-1)).classList.add('missing'));
            return alert("Em ch∆∞a ho√†n th√†nh c√°c c√¢u: " + missing.join(", ") + ". H√£y l√†m xong r·ªìi m·ªõi n·ªôp nh√©!");
        }

        if(confirm("X√°c nh·∫≠n n·ªôp b√†i thi?")) finish();
    }

    function finish() {
        // T√≠nh ƒëi·ªÉm
        score = 0;
        questions.forEach((q, i) => {
            let correct = false;
            if(q.type === 'v1') { if(userAnswers[i] == q.c) { score += 0.25; correct = true; } }
            else if(q.type === 'v2') {
                let cc = 0; q.items.forEach((it, j) => { if(userAnswers[i][j] === it.r) cc++; });
                score += [0, 0.1, 0.25, 0.5, 1.0][cc]; if(cc === 4) correct = true;
            } else { if(userAnswers[i] == q.c) { score += 0.5; correct = true; } }
            if(correct) { const t = document.querySelectorAll('.tile:not(.open)'); if(t.length) t[Math.floor(Math.random()*t.length)].classList.add('open'); }
        });

        document.getElementById('game-main').style.display = 'none';
        document.getElementById('nav-bar').style.display = 'none';
        document.getElementById('final-area').style.display = 'block';
        document.getElementById('final-score-display').innerText = "ƒêI·ªÇM: " + score.toFixed(2) + " / 10";

        let html = "";
        questions.forEach((q, i) => {
            let optH = "";
            if(q.type === 'v1') q.a.forEach((opt, idx) => optH += `<div><b>${['A','B','C','D'][idx]}.</b> ${opt}</div>`);
            else if(q.type === 'v2') q.items.forEach((it, idx) => optH += `<div><b>${['a','b','c','d'][idx]})</b> ${it.l}</div>`);

            html += `<div class='sol-card'>
                <b style='color:var(--gold)'>C√¢u ${q.num} (${q.part===1?'Ph·∫ßn I':(q.part===2?'Ph·∫ßn II':'Ph·∫ßn III')}):</b><br>${q.q}
                <div style='margin:10px 0; color:#8b949e;'>${optH}</div>
                <button class='ai-btn' onclick='toggleAI(${i})'>ü§ñ AI PH√ÇN T√çCH & GI·∫¢I CHI TI·∫æT</button>
                <div class='ai-sol-box' id='ai-box-${i}'>${q.sol}</div>
            </div>`;
        });
        document.getElementById('sol-content').innerHTML = html;
        document.querySelectorAll('.tile').forEach(t => t.classList.add('open'));
        MathJax.typesetPromise();
        fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: studentName, score: score.toFixed(2) }) });
    }

    function toggleAI(idx) { let b = document.getElementById('ai-box-'+idx); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }
</script>
</body>
</html>
