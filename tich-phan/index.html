<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ki·ªÉm Tra - ThS. Tr·∫ßn Tr·ªçng Tr·ªã</title>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
        options: { processHtmlClass: 'mathjax-process' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --correct: #238636; --wrong: #da3633; --gold: #f1c40f; --ai: #8a2be2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; }
        header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid var(--accent); width: 100%; padding-bottom: 10px; }
        #nameModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .name-box { background: var(--card); padding: 30px; border-radius: 15px; text-align: center; border: 2px solid var(--accent); max-width: 400px; }
        .name-input { padding: 12px; width: 85%; font-size: 1.1rem; border-radius: 6px; border: 1px solid var(--accent); margin-bottom: 20px; background: #0d1117; color: white; outline: none; }

        .nav-section { width: 100%; max-width: 1050px; background: #161b22; padding: 10px; border-radius: 10px; border: 1px solid #30363d; margin-bottom: 15px; display: none; flex-direction: column; }
        .nav-group { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 8px; }
        .nav-label { font-size: 0.75rem; color: var(--gold); font-weight: bold; width: 100%; text-align: center; margin-bottom: 3px; }
        .nav-btn { width: 32px; height: 32px; border-radius: 5px; border: 1px solid #30363d; background: #21262d; color: white; cursor: pointer; font-size: 0.8rem; }
        .nav-btn.active { background: var(--accent); border-color: white; font-weight: bold; }
        .nav-btn.done { border-bottom: 3px solid var(--correct); }

        .game-container { max-width: 1050px; width: 100%; display: none; grid-template-columns: 1fr 300px; gap: 15px; }
        @media (max-width: 850px) { .game-container { grid-template-columns: 1fr; } }
        
        .quiz-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #30363d; min-height: 480px; display: flex; flex-direction: column; }
        .part-indicator { color: var(--gold); font-weight: bold; background: #21262d; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid var(--gold); font-size: 0.9rem; }
        .q-text { font-size: 1.05rem; line-height: 1.7; margin-bottom: 15px; text-align: justify; }

        .options-grid { display: grid; gap: 8px; flex-grow: 1; }
        .btn { background: #21262d; border: 1px solid #30363d; color: var(--text); padding: 12px 15px; border-radius: 8px; cursor: pointer; text-align: left; display: flex; gap: 10px; }
        .btn.selected { background: #30363d; border-color: var(--accent); border-width: 2px; }
        
        .tf-row { display: flex; align-items: center; justify-content: space-between; background: #0d1117; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #30363d; }
        .tf-btn-group { display: flex; gap: 5px; }
        .btn-tf { padding: 6px 12px; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; background: #21262d; color: white; font-weight: bold; }
        .btn-tf.active-t { background: var(--correct) !important; }
        .btn-tf.active-f { background: var(--wrong) !important; }

        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .numpad-box { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; }
        .ans-display { background: #000; color: var(--accent); font-size: 1.8rem; padding: 8px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 10px; font-family: monospace; min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .num-btn { background: #30363d; border: 1px solid #58a6ff22; color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }

        .img-container { text-align: center; margin: 10px 0; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .img-container img { max-height: 180px; }

        .control-btn { padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; font-size: 1rem; color: white; flex: 1; }

        #final-area { display: none; width: 100%; max-width: 900px; padding: 20px; }
        .sol-card { background: var(--card); padding: 25px; border-radius: 12px; margin-top: 25px; border: 1px solid #30363d; text-align: left; }
        .ai-btn { background: linear-gradient(45deg, #4b0082, #8a2be2); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .ai-sol-box { display: none; background: #0d1117; padding: 20px; border-radius: 10px; border-left: 4px solid var(--ai); margin-top: 15px; line-height: 1.8; }
        .sol-step { color: var(--gold); font-weight: bold; display: block; margin-top: 10px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="nameModal">
    <div class="name-box">
        <h2 style="color:var(--gold)">H·ªÜ TH·ªêNG KI·ªÇM TRA</h2>
        <p>ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
        <input type="text" id="studentName" class="name-input" placeholder="H·ªç v√† T√™n h·ªçc sinh...">
        <button class="control-btn" style="background:var(--accent); width:100%;" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
    </div>
</div>

<header>
    <h1 style="color:var(--gold); font-size: 1.4rem; margin: 5px 0;">CHINH PH·ª§C T√çCH PH√ÇN 12</h1>
    <p style="margin: 0; font-size: 0.85rem;">ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
</header>

<div class="nav-section" id="nav-section">
    <div class="nav-label">Ph·∫ßn I: 4 Ph∆∞∆°ng √°n</div><div class="nav-group" id="nav-p1"></div>
    <div class="nav-label">Ph·∫ßn II: ƒê√∫ng/Sai</div><div class="nav-group" id="nav-p2"></div>
    <div class="nav-label">Ph·∫ßn III: Tr·∫£ l·ªùi ng·∫Øn</div><div class="nav-group" id="nav-p3"></div>
</div>

<div class="game-container" id="game-main">
    <div class="quiz-card mathjax-process">
        <div id="part-info" class="part-indicator"></div>
        <span id="q-title" style="color:var(--accent); font-weight:bold; margin-bottom:10px; display:block;"></span>
        <div id="q-text" class="question-text"></div>
        <div id="ans-zone" class="options-grid"></div>
        <div style="display:flex; gap:10px; margin-top: auto; padding-top: 20px;">
            <button class="control-btn" style="background:#444;" onclick="moveQ(-1)">TR∆Ø·ªöC</button>
            <button class="control-btn" style="background:var(--accent);" onclick="moveQ(1)">SAU</button>
        </div>
    </div>

    <div class="sidebar">
        <div id="numpad-container" class="numpad-box" style="display:none;">
            <div class="ans-display" id="disp">- - -</div>
            <div class="numpad" id="numpad-btns"></div>
        </div>
        <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid #30363d; text-align:center;">
            <div style="color:var(--gold); font-weight:bold; margin-bottom:10px; font-size: 0.9rem;">H·ªçc sinh: <span id="stu-name" style="color:white"></span></div>
            <button class="control-btn" style="background:var(--wrong); color:white;" onclick="submitTest()">N·ªòP B√ÄI</button>
        </div>
    </div>
</div>

<div id="final-area" class="mathjax-process">
    <div style='text-align:center; padding:30px; background:var(--card); border-radius:15px; border:2px solid var(--gold);'>
        <h2 style='color:var(--gold); margin-top:0;'>HO√ÄN TH√ÄNH</h2>
        <h3 id="final-score" style="color:var(--accent); font-size:2rem;"></h3>
    </div>
    <div id="sol-content"></div>
    <button class="control-btn" style="background:var(--accent); width:100%; margin-top:20px;" onclick="location.reload()">THI L·∫†I</button>
</div>

<script>
    const questions = [
        // PH·∫¶N I: 12 C√ÇU
        { part: 1, num: 1, type: 'v1', q: "M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y l√† <b>sai</b>?", a: ["$\\displaystyle \\int f'(x) dx = f(x)+C$","$\\displaystyle \\int [f(x)+g(x)] dx = \\int f(x)dx + \\int g(x)dx$","$\\displaystyle \\int k f(x) dx = k \\int f(x)dx$","$\\displaystyle \\int [f(x)-g(x)] dx = \\int f(x)dx - \\int g(x)dx$"], c: 2, sol: "<b>AI Ph√¢n t√≠ch chi ti·∫øt:</b><br><span class='sol-step'>- Kh·∫≥ng ƒë·ªãnh C (Sai):</span> T√≠nh ch·∫•t $\\int k f(x) dx = k \\int f(x)dx$ ch·ªâ ƒë√∫ng khi h·∫±ng s·ªë $k \\neq 0$.<br>Trong tr∆∞·ªùng h·ª£p $k=0$, v·∫ø tr√°i l√† $\\int 0 dx = C$ (m·ªôt h·∫±ng s·ªë b·∫•t k·ª≥), trong khi v·∫ø ph·∫£i l√† $0 \\cdot \\int f(x)dx = 0$. V√¨ h·∫±ng s·ªë $C$ kh√¥ng nh·∫•t thi·∫øt b·∫±ng $0$ n√™n kh·∫≥ng ƒë·ªãnh n√†y sai khi kh√¥ng k√®m ƒëi·ªÅu ki·ªán h·∫±ng s·ªë kh√°c $0$.<br><span class='sol-step'>- C√°c ph∆∞∆°ng √°n kh√°c:</span> A ƒë√∫ng theo ƒë·ªãnh nghƒ©a nguy√™n h√†m, B v√† D ƒë√∫ng theo t√≠nh ch·∫•t tuy·∫øn t√≠nh c·ªßa nguy√™n h√†m." },
        { part: 1, num: 2, type: 'v1', q: "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x$ l√†:", a: ["$-\\sin x + C$", "$\\sin x + C$", "$\\cos x + C$", "$-\\cos x + C$"], c: 1, sol: "<b>AI Ph√¢n t√≠ch chi ti·∫øt:</b><br>Ta c·∫ßn t√¨m h√†m s·ªë $F(x)$ sao cho $F'(x) = f(x) = \\cos x$. Theo b·∫£ng ƒë·∫°o h√†m c√°c h√†m l∆∞·ª£ng gi√°c c∆° b·∫£n, ta c√≥ $(\\sin x)' = \\cos x$. Do ƒë√≥, nguy√™n h√†m c·ªßa h√†m s·ªë $\\cos x$ l√† $\\sin x + C$." },
        { part: 1, num: 11, type: 'v1', q: "Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng v·ªÅ di·ªán t√≠ch $S$? <div class='img-container'><img src='cau11.png'></div>", a: ["$S = \\displaystyle \\int_a^b [f_2(x)-f_1(x)] dx$", "$\\displaystyle S = \\int_a^b [f_1(x)-f_2(x)] dx$", "$S = \\displaystyle \\pi \\int_a^b [f_1(x)-f_2(x)]^2 dx$", "$S = \\displaystyle \\pi \\int_a^b [f_1(x)-f_2(x)] dx$"], c: 1, sol: "<b>AI Ph√¢n t√≠ch chi ti·∫øt:</b><br><span class='sol-step'>- Quy t·∫Øc:</span> Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi hai ƒë·ªì th·ªã h√†m s·ªë $y=f_1(x)$ v√† $y=f_2(x)$ tr√™n ƒëo·∫°n $[a;b]$ ƒë∆∞·ª£c t√≠nh b·ªüi c√¥ng th·ª©c $\\int_a^b |f_1(x)-f_2(x)|dx$.<br><span class='sol-step'>- Quan s√°t h√¨nh v·∫Ω:</span> Trong ph·∫°m vi t·ª´ $a$ ƒë·∫øn $b$, ƒë∆∞·ªùng cong $y=f_1(x)$ lu√¥n n·∫±m ph√≠a tr√™n ƒë∆∞·ªùng cong $y=f_2(x)$. Do ƒë√≥ $f_1(x) - f_2(x) \\ge 0$. Ta ph√° d·∫•u gi√° tr·ªã tuy·ªát ƒë·ªëi ƒë∆∞·ª£c c√¥ng th·ª©c ·ªü ph∆∞∆°ng √°n B." },

        // PH·∫¶N II: ƒê√öNG SAI
        { part: 2, num: 1, type: 'v2', q: "Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\dfrac{x^2+1}{x}$ tr√™n $(0 ;+\\infty)$.", 
          items: [ {l: "$F(x) = f'(x), \\forall x \\in (0; +\\infty)$", r: false}, {l: "$F(x)+2025$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$", r: true}, {l: "$F(x) = x^2 + \\ln x + 2025$", r: false}, {l: "Bi·∫øt $F(1) = 3/2$, khi ƒë√≥ $F(x) = \\dfrac{x^2}{2} + 2$", r: false} ], 
          sol: "<b>Gi·∫£i chi ti·∫øt Ph·∫ßn II - C√¢u 1:</b><br><span class='sol-step'>a) Sai:</span> Theo ƒë·ªãnh nghƒ©a, nguy√™n h√†m $F(x)$ th·ªèa m√£n $F'(x) = f(x)$, kh√¥ng ph·∫£i $F(x)=f'(x)$.<br><span class='sol-step'>b) ƒê√∫ng:</span> N·∫øu $F(x)$ l√† nguy√™n h√†m th√¨ $F(x) + C$ (v·ªõi $C$ l√† h·∫±ng s·ªë) c≈©ng l√† nguy√™n h√†m. ·ªû ƒë√¢y $C=2025$.<br><span class='sol-step'>c) Sai:</span> L·∫•y nguy√™n h√†m $f(x) = x + \\frac{1}{x}$ ta ƒë∆∞·ª£c $F(x) = \\frac{x^2}{2} + \\ln|x| + C$. Bi·ªÉu th·ª©c √Ω c sai ·ªü s·ªë h·∫°ng $x^2$ (ph·∫£i l√† $x^2/2$).<br><span class='sol-step'>d) Sai:</span> T·ª´ $F(x) = \\frac{x^2}{2} + \\ln x + C$, thay $x=1$ c√≥ $F(1) = 1/2 + 0 + C = 1.5 \\Rightarrow C=1$. V·∫≠y $F(x) = \\frac{x^2}{2} + \\ln x + 1$." },
        
        { part: 2, num: 4, type: 'v2', q: "Cho $y=f(x)$ c√≥ ƒë·∫°o h√†m $f'(x)$ li√™n t·ª•c tr√™n $(0;+\\infty)$, b·∫£ng bi·∫øn thi√™n $f'(x)$ nh∆∞ h√¨nh: <div class='img-container'><img src='cau4_ds.png'></div>", 
          items: [ {l: "$\\int_2^5 f'(x)dx = f(5)-f(2)$", r: true}, {l: "$\\int_2^3 f'(x)dx = 1$", r: false}, {l: "Di·ªán t√≠ch gi·ªõi h·∫°n b·ªüi $f'(x), Ox, x=2, x=3$ b·∫±ng $1/2$", r: false}, {l: "N·∫øu $\\int_2^5 |f'(x)|dx = 5$ th√¨ $f(5)=5$", r: false} ], 
          sol: "<b>Gi·∫£i chi ti·∫øt Ph·∫ßn II - C√¢u 4:</b><br><span class='sol-step'>a) ƒê√∫ng:</span> √Åp d·ª•ng c√¥ng th·ª©c ƒë·ªãnh nghƒ©a Newton-Leibniz.<br><span class='sol-step'>b) Sai:</span> Tr√™n kho·∫£ng $(2,3)$, $f'(x) < 0$ (d·∫•u √¢m trong BBT), do ƒë√≥ t√≠ch ph√¢n c·ªßa h√†m √¢m tr√™n kho·∫£ng n√†y ph·∫£i l√† s·ªë √¢m. K·∫øt qu·∫£ $1$ l√† v√¥ l√Ω.<br><span class='sol-step'>c) Sai:</span> Di·ªán t√≠ch b·∫±ng $\\int_2^3 |f'(x)|dx = f(2)-f(3) = f(2)+1$. Kh√¥ng c√≥ gi·∫£ thi·∫øt kh·∫≥ng ƒë·ªãnh k·∫øt qu·∫£ n√†y b·∫±ng $0.5$.<br><span class='sol-step'>d) Sai:</span> T√≠ch ph√¢n tr·ªã tuy·ªát ƒë·ªëi b·∫±ng $[f(2)-f(3)] + [f(5)-f(3)] = f(2)+f(5)+2$. N·∫øu b·∫±ng $5$ th√¨ $f(2)+f(5)=3$. Kh√¥ng ƒë·ªß d·ªØ ki·ªán k·∫øt lu·∫≠n $f(5)=5$." },

        // PH·∫¶N III: TR·∫¢ L·ªúI NG·∫ÆN
        { part: 3, num: 2, type: 'v3', q: "Cho c√°c h√†m s·ªë $y=f(x), y=g(x)$ li√™n t·ª•c tr√™n $\\mathbb{R}$. Gi·∫£ s·ª≠ $\\displaystyle \\int_2^7[2f(x)+3g(x)]=2$ v√† $\\displaystyle \\int_2^7[f(x)-2g(x)]=4$. T√≠nh $\\displaystyle \\int_2^7[f(x)-g(x)]$. (L√†m tr√≤n 2 ch·ªØ s·ªë TP).", c: "3.14", 
          sol: "<b>Gi·∫£i chi ti·∫øt Ph·∫ßn III - C√¢u 2:</b><br><span class='sol-step'>B∆∞·ªõc 1:</span> ƒê·∫∑t $A = \\int_2^7 f(x)dx$ v√† $B = \\int_2^7 g(x)dx$.<br><span class='sol-step'>B∆∞·ªõc 2:</span> T·ª´ gi·∫£ thi·∫øt ta c√≥ h·ªá ph∆∞∆°ng tr√¨nh: $\\begin{cases} 2A+3B=2 \\\\ A-2B=4 \\end{cases}$.<br><span class='sol-step'>B∆∞·ªõc 3:</span> Gi·∫£i h·ªá ta ƒë∆∞·ª£c $A=16/7$ v√† $B=-6/7$.<br><span class='sol-step'>B∆∞·ªõc 4:</span> Gi√° tr·ªã c·∫ßn t√¨m l√† $A-B = 16/7 - (-6/7) = 22/7$.<br><span class='sol-step'>K·∫øt lu·∫≠n:</span> $22/7 \\approx 3.1428...$ L√†m tr√≤n ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n l√† <b>3.14</b>." },
        { part: 3, num: 6, type: 'v3', q: "M·ªôt khu√¥n vi√™n d·∫°ng n·ª≠a h√¨nh tr√≤n gi·ªõi h·∫°n b·ªüi parabol $y=x^2$ v√† ƒë∆∞·ªùng tr√≤n $y=\\sqrt{20-x^2}$. T√≠nh ti·ªÅn (ngh√¨n ƒë·ªìng) tr·ªìng hoa m·ªói $m^2$ gi√° 250k. (L√†m tr√≤n h√†ng ƒë∆°n v·ªã). <div class='img-container'><img src='cau6_kq.png'></div>", c: "4985", 
          sol: "<b>Gi·∫£i chi ti·∫øt Ph·∫ßn III - C√¢u 6:</b><br><span class='sol-step'>- Giao ƒëi·ªÉm:</span> Gi·∫£i $x^2 = \\sqrt{20-x^2} \\Rightarrow x^4+x^2-20=0 \\Rightarrow x^2=4 \\Rightarrow x=\\pm 2$.<br><span class='sol-step'>- Di·ªán t√≠ch:</span> $\\displaystyle S = \\int_{-2}^2 (\\sqrt{20-x^2}-x^2)dx \\approx 19.9396 m^2$.<br><span class='sol-step'>- T·ªïng ti·ªÅn:</span> $19.9396 \\times 250 = 4984.9$.<br><span class='sol-step'>K·∫øt qu·∫£:</span> L√†m tr√≤n h√†ng ƒë∆°n v·ªã ƒë∆∞·ª£c <b>4985</b> (ngh√¨n ƒë·ªìng)." }
    ];

    // T·∫°o c√°c c√¢u h·ªèi gi·∫£ ƒë·ªãnh ƒë·ªÉ tr√°nh l·ªói ƒëi·ªÅu h∆∞·ªõng khi th·∫ßy ch∆∞a nh·∫≠p ƒë·ªß 22 c√¢u
    for(let i=1; i<=12; i++) if(!questions.find(x => x.num == i && x.part == 1)) questions.push({part:1, num:i, type:'v1', q:`ƒê·ªÅ b√†i c√¢u ${i} ph·∫ßn I...`, a:['A','B','C','D'], c:0, sol:'L·ªùi gi·∫£i chi ti·∫øt...'});
    for(let i=2; i<=3; i++) if(!questions.find(x => x.num == i && x.part == 2)) questions.push({part:2, num:i, type:'v2', q:`ƒê·ªÅ b√†i c√¢u ${i} ph·∫ßn II...`, items:[{l:'√ù a',r:true},{l:'√ù b',r:false},{l:'√ù c',r:true},{l:'√ù d',r:false}], sol:'L·ªùi gi·∫£i chi ti·∫øt...'});
    for(let i=1; i<=6; i++) if(!questions.find(x => x.num == i && x.part == 3)) questions.push({part:3, num:i, type:'v3', q:`ƒê·ªÅ b√†i c√¢u ${i} ph·∫ßn III...`, c:'0', sol:'L·ªùi gi·∫£i chi ti·∫øt...'});
    
    questions.sort((a,b) => (a.part*100 + a.num) - (b.part*100 + b.num));

    let userAnswers = new Array(questions.length).fill(null);
    let currentIdx = 0;

    function startGame() {
        const input = document.getElementById('studentName').value;
        if(!input.trim()) return alert("H·ªçc sinh nh·∫≠p t√™n nh√©!");
        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('nav-section').style.display = 'flex';
        document.getElementById('game-main').style.display = 'grid';
        document.getElementById('stu-name').innerText = input;
        initNav(); initNumpad(); render();
    }

    function initNav() {
        const p1 = document.getElementById('nav-p1'), p2 = document.getElementById('nav-p2'), p3 = document.getElementById('nav-p3');
        p1.innerHTML = ''; p2.innerHTML = ''; p3.innerHTML = '';
        questions.forEach((q, i) => {
            let b = document.createElement('button');
            b.className = 'nav-btn'; b.id = 'nav-' + i; b.innerText = q.num;
            b.onclick = () => { currentIdx = i; render(); };
            if(q.part === 1) p1.appendChild(b);
            else if(q.part === 2) p2.appendChild(b);
            else p3.appendChild(b);
        });
    }

    function initNumpad() {
        const zone = document.getElementById('numpad-btns');
        const keys = [1,2,3,4,5,6,7,8,9,0,'.','-'];
        zone.innerHTML = keys.map(k => `<button class="num-btn" onclick="pressKey('${k}')">${k}</button>`).join('') + 
                         `<button class="num-btn" style="grid-column:span 3; background:var(--wrong)" onclick="pressKey('C')">X√ìA</button>`;
    }

    function render() {
        const q = questions[currentIdx];
        document.getElementById('part-info').innerText = q.part === 1 ? "PH·∫¶N I. TR·∫ÆC NGHI·ªÜM 4 PH∆Ø∆†NG √ÅN" : (q.part === 2 ? "PH·∫¶N II. TR·∫ÆC NGHI·ªÜM ƒê√öNG SAI" : "PH·∫¶N III. TR·∫ÆC NGHI·ªÜM TR·∫¢ L·ªúI NG·∫ÆN");
        document.getElementById('q-title').innerText = "C√¢u " + q.num + ".";
        const zone = document.getElementById('ans-zone'); zone.innerHTML = '';
        document.getElementById('q-text').innerHTML = q.q;
        const numpad = document.getElementById('numpad-container'); numpad.style.display = 'none';

        if(q.type === 'v1') {
            q.a.forEach((opt, i) => {
                let b = document.createElement('button'); b.className = 'btn';
                if(userAnswers[currentIdx] === i) b.classList.add('selected');
                b.innerHTML = `<b>${['A','B','C','D'][i]}.</b> ${opt}`;
                b.onclick = () => { userAnswers[currentIdx] = i; render(); updateNav(); };
                zone.appendChild(b);
            });
        } else if(q.type === 'v2') {
            let curV2 = userAnswers[currentIdx] || [null, null, null, null];
            q.items.forEach((item, i) => {
                let d = document.createElement('div'); d.className = 'tf-row';
                d.innerHTML = `<div><b>${['a','b','c','d'][i]})</b> ${item.l}</div>
                    <div class="tf-btn-group">
                        <button class='btn-tf ${curV2[i] === true ? 'active-t' : ''}' onclick='setTF(${i},true)'>ƒê√∫ng</button>
                        <button class='btn-tf ${curV2[i] === false ? 'active-f' : ''}' onclick='setTF(${i},false)'>Sai</button>
                    </div>`;
                zone.appendChild(d);
            });
        } else {
            numpad.style.display = 'block';
            document.getElementById('disp').innerText = userAnswers[currentIdx] || "- - -";
        }
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + currentIdx).classList.add('active');
        MathJax.typesetPromise();
    }

    function setTF(idx, val) {
        if(!userAnswers[currentIdx]) userAnswers[currentIdx] = [null, null, null, null];
        userAnswers[currentIdx][idx] = val; render(); updateNav();
    }

    function pressKey(k) {
        let cur = userAnswers[currentIdx] || "";
        if(k === 'C') cur = ""; else if(cur.length < 10) cur += k;
        userAnswers[currentIdx] = cur;
        document.getElementById('disp').innerText = cur || "- - -";
        updateNav();
    }

    function moveQ(step) { let next = currentIdx + step; if(next >= 0 && next < questions.length) { currentIdx = next; render(); } }

    function updateNav() {
        questions.forEach((q, i) => {
            let b = document.getElementById('nav-' + i); b.classList.remove('done');
            let ans = userAnswers[i];
            if(q.type === 'v2') { if(ans && !ans.includes(null)) b.classList.add('done'); }
            else { if(ans !== null && ans !== "") b.classList.add('done'); }
        });
    }

    function submitTest() {
        let missing = [];
        questions.forEach((q, i) => {
            let ans = userAnswers[i];
            if(q.type === 'v2') { if(!ans || ans.includes(null)) missing.push(`C√¢u ${q.num} Ph·∫ßn II`); }
            else { if(ans === null || ans === "") {
                let pName = q.part==1?"Ph·∫ßn I":"Ph·∫ßn III";
                missing.push(`C√¢u ${q.num} ${pName}`);
            }}
        });
        if(missing.length > 0) return alert("Ch∆∞a xong:\n" + missing.join("\n"));
        if(confirm("X√°c nh·∫≠n n·ªôp b√†i?")) finish();
    }

    function finish() {
        let scoreVal = 0;
        questions.forEach((q, i) => {
            if(q.type === 'v1' && userAnswers[i] == q.c) scoreVal += 0.25;
            else if(q.type === 'v2' && userAnswers[i]) {
                let cc = 0; q.items.forEach((it, j) => { if(userAnswers[i][j] === it.r) cc++; });
                scoreVal += [0, 0.1, 0.25, 0.5, 1.0][cc];
            } else if(q.type === 'v3' && userAnswers[i] == q.c) scoreVal += 0.5;
        });

        document.getElementById('game-main').style.display = 'none';
        document.getElementById('nav-section').style.display = 'none';
        document.getElementById('final-area').style.display = 'block';
        document.getElementById('final-score').innerText = "ƒêi·ªÉm c·ªßa em: " + scoreVal.toFixed(2);

        let html = "";
        questions.forEach((q, i) => {
            let optH = "";
            if(q.type === 'v1') q.a.forEach((opt, idx) => optH += `<div style='margin:5px 0 5px 20px; color:${q.c==idx?'#2ecc71':''}'><b>${['A','B','C','D'][idx]}.</b> ${opt} ${q.c==idx?'(ƒê√∫ng)':''}</div>`);
            else if(q.type === 'v2') q.items.forEach((it, idx) => optH += `<div style='margin:5px 0 5px 20px;'><b>${['a','b','c','d'][idx]})</b> ${it.l} <span style='color:var(--gold)'>[${it.r?'ƒê√∫ng':'Sai'}]</span></div>`);
            
            html += `<div class='sol-card'>
                <div style='background:#0d1117; padding:20px; border-radius:10px;'>
                    <b style='color:var(--gold)'>C√¢u ${q.num} (${q.part==1?'Ph·∫ßn I':(q.part==2?'Ph·∫ßn II':'Ph·∫ßn III')}):</b><br>${q.q}
                    <div style='margin-top:15px; border-top:1px solid #21262d; padding-top:10px;'>${optH}</div>
                </div>
                <button class='ai-btn' onclick='toggleAI(${i})'>ü§ñ PH√ÇN T√çCH AI & GI·∫¢I CHI TI·∫æT</button>
                <div class='ai-sol-box' id='box-${i}'>${q.sol}</div>
            </div>`;
        });
        document.getElementById('sol-content').innerHTML = html;
        MathJax.typesetPromise();
    }
    function toggleAI(idx) { let b = document.getElementById('box-'+idx); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }
</script>
</body>
</html>
